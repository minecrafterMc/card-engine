<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      @font-face {
        font-family: lato;
        src: url(/assets/fonts/lato/Lato-Black.ttf);
      }
      canvas {
        width: 100%;
        height: 100%;
        position: absolute;
        left: 0px;
        top: 0px;
      }
      </style>
  </head>
  <body></body>
  <script src="/libs/phaser.js"></script>
  <script src="/engine.js"></script>
  <script src="/card-generator"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    socket.on("connect", (e) => {
      
    });
    const cardColors = { h: "red", d: "orange", s: "black", c: "blue" };
    const cardValues = ["A", 2, 3, 4, 5, 6, 7, 8, 9, 10, "J", "Q", "K"];
    const shapes = {};
    const cards = {};
    const loadPromise = new Promise((resolve, reject) => {
      let loaded = 0;
      for (let i = 0; i < Object.keys(cardColors).length; i++) {
        const color = Object.keys(cardColors)[i];
        shapes[color] = new shape(
          cardColors[color],
          "/assets/" + color + "_symbol.png",
          function () {
            loaded++;
          },
        );
      }
      var checker = setInterval(() => {
        if (loaded >= 4) {
          clearInterval(checker);
          resolve();
        }
      }, 100);
    }).then(() => {
      var scene;
      const cards = [];
      for (let value of cardValues) {
        for (let i = 0; i < Object.keys(cardColors).length; i++) {
          const color = Object.keys(cardColors)[i];
          cards[value + color] = renderCard(shapes[color], value);
        }
      }
      cards["back"] = renderCard(null, "SPECIAL_BACK");
      const game = new Phaser.Game({
        type: Phaser.AUTO,
        width: window.innerWidth,
        height: window.innerHeight,
        scene: {
          preload: function () {
            for (let value of cardValues) {
              for (let i = 0; i < Object.keys(cardColors).length; i++) {
                const color = Object.keys(cardColors)[i];
                this.load.image(
                  value + color,
                  cards[value + color].src,
                );
              }
            }
            this.load.image("back", cards["back"].src);
          },
          create: create,
        },
      });
      function create() {
        scene = this;
        socket.on("dealHand", (data) => {
          hand = data.hand;
          displayHand();
        });
        for (let i = 0; i< 6; i++){
          hand.push(RandomInt(2,10)+["h","d","s","c"][RandomInt(0,3)]);
        }
        displayHand();
      }
      function displayHand(){
        for (let c of cards){
          c.destroy();
        }
        for (let i = 0; i < hand.length;i++){
            cards[i] = scene.add.sprite(window.innerWidth / 2 + (i-hand.length/2)*80, window.innerHeight - 150, hand[i]);
            cards[i].setScale(0.4);
            cards[i].setInteractive();
            cards[i].on('pointerover', function (pointer) {
                this.y -= 20;
            });
            cards[i].on('pointerout', function (pointer) {
                this.y += 20;
            });
            cards[i].on('pointerdown', function (pointer) {
                socket.emit("playCard", { card: i });
            });

        }
      }
    });
    function debug (msg) {
      socket.emit("debug", msg);
    }
  </script>
</html>
